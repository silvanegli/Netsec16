\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{float}
\usepackage{paralist}

% ToDo's
\usepackage{color}

\newcommand{\mynote}[3]{
  \textcolor{#2}{
    \fbox{\bfseries\sffamily\scriptsize#1}
    {\small\textsf{\emph{#3}}}
}}

\title{JSON Web Tokens and Bash Injection}
\author{Network Security HS16 - Group 6\\Lukas Bischofberger, Silvan Egli, Jonas Passerini, Lukas Widmer}

\begin{document}

\maketitle

\begin{abstract}
%a short summary of the challenge. You should include the problem or vulnerability addressed by the challenge and the approach used to exploit the vulnerability.

A chat services suffers from two vulnerabilities, which allow an arbitrary user to gain administrative access rights and to extract the secret key of the web application by performing a bash injection.
The first part of the challenge is a JSON Web Token (JWT) vulnerability where the client is able to select a trivial 'none' signing algorithm. Using a fake authentication token, it is possible to circumvent the authentication mechanism and send chat messages as an administrator. This enables a normal user to send privileged admin commands.
The second part of the challenge exploits a bash injection, which is possible due to a wrongly configured subprocess call with unsanitized user input and therefore allows arbitrary code execution. A malicious admin command can be crafted to extract the secret key from the settings file.

\end{abstract}

\section{Challenge Description}

\subsection{Type of Challenge}
%whether the challenge is online or offline. For example, exploiting a web application requires the application to be online, whereas analyzing captured packets can be done offline.

The first part of the challenge requires to analyze and craft authentication tokens, which can be done offline. To test the crafted tokens, the web application needs to be online.

For the second part of the challenge, the web application needs to be running in order to extract the secret key, and is therefore an online attack.


\subsection{Category}
%one or more categories for the challenge. You can see a full list of possible challenges by going to the Hacking Lab home page, clicking the Statistics tab near the center of the page, and then clicking Challenge Details under the Challenge Statistics box.

The challenge belongs to the category Web Security and also requires some basic Linux and Networking understanding.

\subsection{Mission}
%a summary of the challenge objective. For example, a school's online registration form may have an SQL injection vulnerability. Using SQL injection in this form to execute a DROP statement can cause a school to lose their entire year's student records.

A simple chat service is provided by a company in the form of a web application. There is only one chat room, and all authenticated users might read messages and send new ones to this chat room. There is an additional administrative role, which allows users belonging to this role to invoke several admin commands, e.g. to change the background color of the chat window. Admin commands sent by basic users have no effect.

The secret key used by the chat service is  highly sensitive, since it is also used by other services of the company. The goal of the challenge is to expose the secret key.
To achieve the goal, two vulnerabilities need to be combined in a clever way.
In a first step, an attacker has access to a basic user account and the goal is to gain administrative user rights by circumventing the token based authentication mechanism.
In a second step, the attacker uses the administrative rights gained in the previous step to craft a malicious admin command, which exposes the secret key.


\subsection{Learning Goal}
%what you hope students will learn from the challenge and why it is important. For example, if the challenge is to perform a TLS-based man-in-the-middle attack using a similar-looking domain name, students will learn the importance of checking that the domain name in the certificate matches the one in the address bar. This is important because it is usually much easier to obtain a fraudulent certificate for a similar-looking domain name than for the actual domain.

The first part of the challenge teaches the student about how to collect and analyze token based authentication mechanisms, in particular JSON Web Tokens. The vulnerability should increase the awareness of the problem, if the client is allowed to choose the signing algorithm.

The second part of the challenge demonstrates the danger of executing unsanitized input from an untrusted source and how to exploit such a vulnerability with a limited interface.


\section{Implementation}
%\subsection{Requirements}

The web application is implemented in Python using the web framework Django and SQLite is used as the database backend. Token based authentication is provided by pyjwt, a Python implementation of JSON Web Tokens, which is either outdated or patched to enable the first vulnerability. The frontend of the chat application is implemented using Angular2. The admin commands are parsed by the web framework and then executed with a bash command in a subprocess, without sanitizing the input first. The bash commands have direct access to the local file system and allow an attacker to perform a bash injection.


\section{Solution}

\subsection{Hints}
%up to three hints to give to users solving the challenge.
\begin{enumerate}
	\item Analyze the tokens used to authenticate chat messages. Can you decode the token to reveal further information about the library used to verify the tokens?
	\item The admin commands do not require any database access. Try to find out what happens, e.g. if an administrator changes the background color of the chat window.
	\item The secret key of a Django applications is usually stored in a file called settings.py
\end{enumerate}

\subsection{Step-by-Step Instructions}
%a description of every step a user has to perform to solve the challenge. This does not need to be the final version, but it should allow us to get a feel for the challenge.
\begin{enumerate}
	\item Exploit the JWT web token vulnerability to bypass authentication
	\begin{enumerate}
		\item Collect and analyze the authentication tokens used by the application to authenticate chat messages. To do so, you can use Wireshark or the Firefox Add-on Tamper Data.
		\item Decode the base64 encoded tokens and check its content.
		\item A short Google search should reveal several vulnerabilities, such as the "none" Algorithm described on the auth0.com blog~\footnote{\url{https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/}}.
		\item Learn about the algorithm and create your own token, which authenticates you as the administrator. To find the ID of an administrator you might need to look at the source of the chat history.
		\item You should be able to send chat messages as an administrator and invoke admin commands.
	\end{enumerate}
	\item Perform a bash injection by crafting a malicious admin command
	\begin{enumerate}
		\item Try to find out how admin commands work. Observe the CSS style sheet and observe that the color values are directly written into the CSS file.
		\item Find a bash command to read and print the contents of a file, which could be used as a color value. e.g. cat settings.py
		\item Embed the bash command in an admin command, such that instead of the color value the output of your bash command is written into the CSS file. Note that in bash injections, it is often not possible to inject commands with white space characters and you might need to modify your bash command accordingly. An example for an admin command could be: \textbackslash\textbackslash background \$({cat,settings.py})
		\item Take a look again at the CSS file, which should now contain the secret key. It is also possible to perform different attacks, e.g. to open a reverse shell and then manually searching the secret key.
	\end{enumerate}
	
\end{enumerate}

\section{Mitigation}
%how can the vulnerability be fixed or mitigated so that the challenge exploit does not work? For example, if the challenge vulnerability is that an HTTPS request can be intercepted and rewritten as an HTTP request, a mitigation is to have the server's response enforce the future use of HTTPS. This would protect against future attacks, though not an ongoing attack.

The JWT vulnerability can be solved by disallowing clients to choose an algorithm, especially disallowing the 'none' algorithm. Additionally, all dependencies should be kept up to date to prevent other vulnerabilities.

The bash injection vulnerability can be prevented by properly sanitizing the user input and by disabling the shell access. A nicer solution would be to prevent the use of subprocesses completely and instead manage the color configuration within Django, e.g. by writing the values to the database and dynamically parse the website using a templating system.

The attacker had full access to the system by executing arbitrary commands or opening a reverse shell, therefore the whole system is compromised and all keys should be renewed, including all the systems which used the same secret key.



\section{Conclusion}
The presented challenge consists of two vulnerabilities and demonstrates how they can be combined to extract the secret key of a web application. The student learns how JWT works and how the token authentication can be bypassed, if the client is able to select a weak or even trivial signing algorithm.
The student also learns how to perform a bash injection by exploiting a subprocess call suffering from unsanitized user input.
Both vulnerabilities reflect common problems, which could mostly be tackled in a simple way.

\end{document}
